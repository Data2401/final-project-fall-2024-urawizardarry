---
title: "Spells and Spreadsheets: Decoding the Wizarding World with Data Science"
author: "Viviana Lara, Justin Cline"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

In the realm of fantasy literature and cinema, few franchises have captured the imagination quite like Harry Potter. But beyond the spellbinding narratives lies a wealth of data waiting to be explored. Our analysis aims to uncover the hidden patterns and insights within the Harry Potter movie series, using a comprehensive dataset that spans characters, dialogue, spells, potions, and movie statistics.

The central question we seek to answer is: How do the various elements of the Harry Potter universe interact and evolve throughout the series? To address this, we'll be diving into multiple CSV files, including:

- **Chapters.csv:** Contains information about movie chapters, including character IDs, chapter names, movie IDs, and chapter numbers within each movie script.
- **Characters.csv:** Provides detailed information about characters, including their species, gender, Hogwarts house, patronus, and wand properties.
- **Dialogue.csv:** Contains every line of dialogue from the movie scripts, linked to characters, chapters, and locations.
- **Movies.csv:** Offers production details for each movie, including title, release year, runtime, budget, and box office performance.
- **Places.csv:** Lists various locations in the Harry Potter universe, categorized by type.
- **Spells.csv:** Details the various spells used in the series, including their incantations, effects, and associated light.

By analyzing this rich dataset, we aim to reveal trends in character development, explore the complexity of magic over time, and even draw connections between the fictional world and real-world factors like movie budgets and audience reception. Whether you're a die-hard fan or a data enthusiast, this analysis promises to shed new light on the intricate tapestry of the wizarding world, all through the lens of data science.

---

# About the Dataset
```{r message = FALSE, warning = FALSE}
# Loading Required Libraries
library(dplyr)
library(tidyverse) # Needed for a variety of functions related to dataframe manipulation
library(ggplot2) # Needed for plotting data
library(stringr) # Needed for the str_detect() function to manipulate our dataset
library(knitr)      # for kable function
library(kableExtra) # for kable_styling
```

```{r message = FALSE}
# Reading the Datasets
Chapters <- read.csv("HPDatasets/Chapters.csv")
Characters <- read.csv("HPDatasets/Characters.csv")
Data_Dict <- read.csv("HPDatasets/Data_Dictionary.csv")
Movies <- read.csv("HPDatasets/Movies.csv")
Dialogue <- read.csv("HPDatasets/Dialogue.csv")
Places <- read.csv("HPDatasets/Places.csv")
Spells <- read.csv("HPDatasets/Spells.csv")
```


# House Dynamics

### Distribution of Characters Across Hogwarts Houses
```{r message = FALSE, warning = FALSE}
Characters %>% # main data frame containing character information
  filter(!is.na(House) & House != "") %>%  # filter out characters without a house and NA
  # mutate creates new columns and transforms the data
  mutate(House_Display = House,  # keeps original names for legend
         House = case_when(
           House == "Beauxbatons Academy of Magic" ~ "Beauxbatons",
           House == "Durmstrang Institute" ~ "Durmstrang",
           TRUE ~ House
         )) %>%
  ggplot(aes(x = House, 
             fill = House_Display)) +
  geom_bar() + # creates bar chart visualization
  geom_text(aes(label = after_stat(count)), 
            position = position_fill(),
            stat = "count", 
            color = "white", 
            size = 3) +
  labs(title = "Distribution of Characters Across Houses",
       x = "House", y = "Count",
       fill = "School") +  # legend title
  theme_minimal() + # minimal theme styling
  # custom colors to houses
  scale_fill_manual(values = c("Gryffindor" = "#740001",
                              "Slytherin" = "#1A472A",
                              "Ravenclaw" = "#0E1A40",
                              "Hufflepuff" = "#FFD800",
                              "Beauxbatons Academy of Magic" = "#87CEEB",
                              "Durmstrang Institute" = "#DC143C")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), # ajust x-axis labels
        legend.text = element_text(size = 8))  # legend text size
```


### Gender Distribution
```{r}
Gender.Distribution <- Characters %>%
  filter(!is.na(House) & House != "" & !is.na(Gender)) %>%
  mutate(House = case_when(
    House == "Beauxbatons Academy of Magic" ~ "Beauxbatons",
    House == "Durmstrang Institute" ~ "Durmstrang",
    TRUE ~ House
  )) %>%
  group_by(House, Gender) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  group_by(House) %>%
  mutate(Percentage = Count / sum(Count) * 100)

# plot
ggplot(Gender.Distribution, aes(x = House, 
                                y = Percentage, 
                                fill = Gender)) +
  geom_bar(stat = "identity", 
           position = "stack") +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), 
            position = position_stack(vjust = 0.5), 
            color = "white", size = 3) + # adds percentage inside bars
  labs(title = "Gender Distribution Among Houses",
       x = "House", 
       y = "Percentage") +
  scale_fill_manual(values = c("Female" = "#FF69B4",
                               "Male" = "#4169E1")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Blood Status Diversity

```{r}
# Filter and prepare data, excluding NA and empty values
Blood.Status <- Characters %>%
  filter(!is.na(House) & House != "" & 
         !is.na(Blood.Status) & Blood.Status != "") %>%
  mutate(House = case_when(
    House == "Beauxbatons Academy of Magic" ~ "Beauxbatons",
    House == "Durmstrang Institute" ~ "Durmstrang",
    TRUE ~ House ))

ggplot(Blood.Status, aes(x = House, fill = Blood.Status)) +
  geom_bar(position = "fill") +
  geom_text(aes(label = after_stat(count)), 
            position = position_fill(vjust = 0.5),
            stat = "count", 
            color = "white", 
            size = 3) +
  labs(title = "Blood Status Distribution Across Houses",
       x = "House",
       y = "Proportion",
       fill = "Blood Status") +
  scale_fill_manual(values = c(
    "Pure-Blood" = "#4A0404",     # Dark red
    "Half-Blood" = "#000080",     # Dark blue
    "Muggle-Born" = "#FFB347",     # Light orange
    "Half-Giant" = "#848482", # Silver
    "Quarter-Veela" = "#87CEEB",
    "Part-Goblin" = "darkgreen"
  )) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_line(color = "#E0E0E0"),
    panel.grid.minor = element_blank()
  )
```

### Hair Color
```{r warning=FALSE}
# Filter and prepare data for hair color analysis
Hair.Color.Distribution <- Characters %>%
  filter(!is.na(House) & House != "" & 
         !is.na(Hair.Color) & Hair.Color != "") %>%
  mutate(House = case_when(
    House == "Beauxbatons Academy of Magic" ~ "Beauxbatons",
    House == "Durmstrang Institute" ~ "Durmstrang",
    TRUE ~ House
  ))

# Calculate percentages
Hair.Color.Percentages <- Hair.Color.Distribution %>%
  group_by(House, Hair.Color) %>%
  summarise(count = n()) %>%
  group_by(House) %>%
  mutate(percentage = round((count / sum(count)) * 100, 1))

# Create visualization
ggplot(Hair.Color.Percentages, aes(x = House, y = percentage, fill = Hair.Color)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), 
            position = position_stack(vjust = 0.5),
            size = 3,
            color = "white") +
  labs(title = "Hair Color Distribution Across Houses",
       x = "House",
       y = "Percentage",
       fill = "Hair Color") +
  scale_fill_manual(values = c(
    "Black" = "#000000",
    "Blonde" = "#E0C092",
    "Brown" = "#72442b",
    "Red" = "orangered",
    "Grey" = "#808080",
    "White" = "#F8EBD5",
    "Bald" = "pink",
    "Silver" = "lightgray",
    "Green" = "lightgreen",
    "Dark" = "#4d2d1a",
    "Auburn" = "#9a3300",
    "Variable" = "purple",
    "Tawny" = "#cca57d"
  )) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_line(color = "#E0E0E0"),
    panel.grid.minor = element_blank()
  )
```

### Eye Color
```{r}
# Filter and prepare data for eye color analysis
Eye.Color.Distribution <- Characters %>%
  filter(!is.na(Eye.Color) & Eye.Color != "") %>%
  group_by(Eye.Color) %>%
  summarise(
    Count = n(),
    Percentage = round(n() / nrow(filter(Characters, !is.na(Eye.Color) & Eye.Color != "")) * 100, 1)
  ) %>%
  arrange(desc(Percentage))

# Create visualization
ggplot(Eye.Color.Distribution, aes(x = reorder(Eye.Color, Percentage), y = Percentage, fill = Eye.Color)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), 
            hjust = -0.1) +
  coord_flip() +
  labs(title = "Distribution of Eye Colors",
       x = "Eye Color",
       y = "Percentage") +
  scale_fill_manual(values = c(
    "Blue" = "#1E90FF",
    "Brown" = "#8B4513",
    "Green" = "#228B22",
    "Grey" = "#808080",
    "Black" = "#000000",
    "Dark" = "#2F4F4F",
    "Hazel" = "#DEB887",
    "Yellow" = "yellow",
    "Silver" = "lightgrey",
    "Scarlet" = "#FF2400",
    "Pale" = "beige",
    "Ruddy" = "#ff0028",
    "Variable" = "purple",
    "Gooseberry" = "#E6EAC0"
  )) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.y = element_blank()
  ) +
  scale_y_continuous(limits = c(0, max(Eye.Color.Distribution$Percentage) * 1.2))
```

### Patronus Forms
```{r}
# Count frequency of each Patronus form
Patronus.Count <- Characters %>%
  filter(!is.na(Patronus) & Patronus != "") %>%
  group_by(Patronus) %>%
  summarise(
    Count = n(),
    Percentage = round(n() / sum(!is.na(Characters$Patronus) & Characters$Patronus != "") * 100, 1)
  ) %>%
  arrange(desc(Count))

# Display table using kable
kable(head(Patronus.Count, 10),
      col.names = c("Patronus Form", "Number of Characters", "Percentage"),
      caption = "Top 10 Most Common Patronus Forms") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r warning=FALSE}
# Join Characters table to get house and patronus information
House.Patronus <- Characters %>%
  filter(!is.na(House) & House != "" & !is.na(Patronus) & Patronus != "") %>%
  mutate(House = case_when(
    House == "Beauxbatons Academy of Magic" ~ "Beauxbatons",
    House == "Durmstrang Institute" ~ "Durmstrang",
    TRUE ~ House
  ))

# Create contingency table
House.Patronus.Table <- table(House.Patronus$House, House.Patronus$Patronus)

# Perform chi-square test
ChiTest <- chisq.test(House.Patronus.Table)

# Create visualization
ggplot(House.Patronus, aes(x = House, fill = Patronus)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Patronus Forms by House",
       x = "House",
       y = "Proportion") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        legend.text = element_text(size = 8))
```



# Dialogue Analysis
### Frequently used words
```{r message=FALSE, warning=FALSE}
library(RColorBrewer)
library(tidytext)
library(wordcloud)

# Prepare the data
word_counts <- Dialogue %>%
  unnest_tokens(word, Dialogue) %>%
  anti_join(stop_words) %>%
  count(word, sort = TRUE)

# Create the word cloud
set.seed(1234)
wordcloud(words = word_counts$word, 
          freq = word_counts$n, 
          min.freq = 1,
          max.words = 100, 
          random.order = FALSE, 
          rot.per = 0.35, 
          colors = brewer.pal(8, "Dark2"))
```

```{r message=FALSE, warning=FALSE}
# Create frequency table of most common words
Word.Freq.Table <- Dialogue %>%
  unnest_tokens(word, Dialogue) %>%
  anti_join(stop_words) %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(percentage = n/sum(n)*100)

# Display table using kable
kable(Word.Freq.Table,
      col.names = c("Word", "Frequency", "Percentage"),
      digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(2:3, width = "100px") %>%
  add_header_above(c(" " = 1, "Word Statistics" = 2))
```


### Locations with Most Dialogue
```{r}
# Count dialogues per location
Dialogue.Count <- Dialogue %>%
  group_by(Place.ID) %>%
  summarise(Dialogue_Count = n()) %>%
  arrange(desc(Dialogue_Count))

# Join with places to get place names
TopLocations <- Dialogue.Count %>%
  left_join(Places, by = "Place.ID") %>%
  top_n(10, Dialogue_Count)

# Visualize top 10 locations with most dialogue
ggplot(TopLocations, aes(x = reorder(Place.Name, Dialogue_Count), y = Dialogue_Count)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Locations with Most Dialogue",
       x = "Location",
       y = "Number of Dialogue Lines") +
  theme(axis.text.y = element_text(angle = 0, hjust = 1))
```



### Representation of Different Houses in Dialogue Across the Movie Series

```{r}
# Join Characters and Dialogue tables to get house information for each dialogue
House.Dialogue <- Dialogue %>%
  left_join(Characters, by = "Character.ID") %>%
  filter(!is.na(House) & House != "") %>%
  # Simplify school names
  mutate(House = case_when(
    House == "Beauxbatons Academy of Magic" ~ "Beauxbatons",
    House == "Durmstrang Institute" ~ "Durmstrang",
    TRUE ~ House
  ))

# Count dialogues per house per movie
House.Representation <- House.Dialogue %>%
  left_join(Chapters, by = "Chapter.ID") %>%
  left_join(Movies, by = "Movie.ID") %>%
  group_by(Movie.Title, House) %>%
  summarise(Dialogue_Count = n(), .groups = 'drop') %>%
  group_by(Movie.Title) %>%
  mutate(Percentage = Dialogue_Count / sum(Dialogue_Count) * 100,
         # Create shorter movie names
         Movie.Short = case_when(
           Movie.Title == "Harry Potter and the Philosopher's Stone" ~ "HP 1",
           Movie.Title == "Harry Potter and the Chamber of Secrets" ~ "HP 2",
           Movie.Title == "Harry Potter and the Prisoner of Azkaban" ~ "HP 3",
           Movie.Title == "Harry Potter and the Goblet of Fire" ~ "HP 4",
           Movie.Title == "Harry Potter and the Order of the Phoenix" ~ "HP 5",
           Movie.Title == "Harry Potter and the Half-Blood Prince" ~ "HP 6",
           Movie.Title == "Harry Potter and the Deathly Hallows Part 1" ~ "HP 7.1",
           Movie.Title == "Harry Potter and the Deathly Hallows Part 2" ~ "HP 7.2"
         ))

# Create visualization
ggplot(House.Representation, 
       aes(x = Movie.Short, 
           y = Percentage, 
           fill = House)) +
  geom_bar(stat = "identity", 
           position = "stack") +
  labs(title = "House Representation in Dialogue Across Movies",
       x = "Movie",
       y = "Percentage of Dialogue") +
  scale_fill_manual(values = c(
    "Gryffindor" = "#740001",
    "Slytherin" = "#1A472A",
    "Ravenclaw" = "#0E1A40",
    "Hufflepuff" = "#FFD800",
    "Beauxbatons" = "#87CEEB",
    "Durmstrang" = "#DC143C"
  )) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
# Create summary table of house dialogue representation
House.Summary <- House.Dialogue %>%
  left_join(Chapters, by = "Chapter.ID") %>%
  left_join(Movies, by = "Movie.ID") %>%
  group_by(House) %>%
  summarise(
    Total_Lines = n(),
    Percentage = round(n() / nrow(House.Dialogue) * 100, 1)
  ) %>%
  arrange(desc(Total_Lines))

# Display table using kable
kable(House.Summary,
      col.names = c("House", "Total Lines of Dialogue", "Percentage of All Dialogue"),
      caption = "Overall House Representation in Dialogue") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```





